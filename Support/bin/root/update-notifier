#!/usr/bin/env bash

# This scripts is meant to be run in the background to
# checks for system updates. If any are found it reopens
# itself in a terminal window with the upgrades ready
# to be installed.

#####################################################
#
#                   Aliases
#
#####################################################

shopt -s expand_aliases

# Echoes normally if from terminal emulator, otherwise uses syslog
tty -s && alias print='echo' || alias print='logger'

#####################################################
#
#                   Functions
#
#####################################################

# Prints a log-like entry, adding the current date
# to the passed message
#
# Arguments:
#   - $1: The message to be logged.
function log {
    local MESSAGE="$1"

    print "$MESSAGE" on "$(date +'%d-%m-%Y %T')"
}

#####################################################
#
#           Terminal: ready to upgrade
#
#####################################################

if tty -s; then
	apt-get upgrade
	exit 0
fi

#####################################################
#
#       Background: checking for updates
#
#####################################################

apt-get update
apt-get upgrade --assume-no

if [[ $? -eq 0 ]]; then
    log 'Update-notifier: updates not found'
else
    log 'Update-notifier: updates found'

    # Updates found, opening terminal window
    run-in-terminal "bash $0"
fi
