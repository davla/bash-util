#!/usr/bin/env bash

# This script adapts the UI scaling to the screen resolution:
# it is upscaled for HIDPI resolutions and scaled back to
# normal for standard ones.

#####################################################
#
#                   Parameters
#
#####################################################

# The value of dots-per-mm below which the screen is considered not HIDPI
DPMM_THRESHOLD='5'

#####################################################
#
#           Resolution-dependent values
#
#####################################################

# Line-by-line comments:
# Getting dysplays Data
# Filter data about connected displays only
# Extracting resolution and screen size
# Getting the digits only
# Grouping digits by four, that is reslution and size per screen
# Printing the x-axis dots-per-mm value for every screen
# Concatenating the dpmm values
# Removign trailing comma
# Printing whether the minimum of the dpmm is below the threshold
#       The call to min() is wrapped in a list because without it
#       min() could be called with one argument only, making it fail
IS_DPMM_LOW=$(xrandr \
        | grep -w connected \
        | grep -oP '(\d+mm x \d+mm|\d+x\d+)' \
        | grep -oP '\d+' \
        | xargs -n 4 \
        | awk '{print $1/$3","}' \
        | xargs \
        | sed 's/,$//' \
        | xargs -i python3 -c "print(min([{}]) < $DPMM_THRESHOLD)")

#####################################################
#
#           Resolution-dependent values
#
#####################################################

if [[ "${IS_DPMM_LOW,,}" == 'true' ]]; then
    # Downscaling

    CURSOR_SIZE=24
    DPI=90
    EYES_THEME='Default-tiny'
    ICON_SIZES="''"
    PANEL_SIZE=24
    SYSTRAY_ICON_SIZE=22
    THUNAR_ICON_SIZE='THUNAR_ICON_SIZE_SMALL'
    THUNAR_WINDOW_HEIGHT=520
    THUNAR_WINDOW_WIDTH=700
    THUNAR_ZOOM='THUNAR_ZOOM_LEVEL_NORMAL'
    WINDOW_MANAGER_THEME='Stoneage'
else
    # Upscaling

    CURSOR_SIZE=48
    DPI=180
    EYES_THEME='Default'
    ICON_SIZES='gtk-menu=40,40:gtk-button=45,45:gtk-dialog=48,48:
    gtk-small-toolbar=45,45:gtk-large-toolbar=45,45'
    PANEL_SIZE=48
    SYSTRAY_ICON_SIZE=43
    THUNAR_ICON_SIZE='THUNAR_ICON_SIZE_LARGE'
    THUNAR_WINDOW_HEIGHT=965
    THUNAR_WINDOW_WIDTH=1270
    THUNAR_ZOOM='THUNAR_ZOOM_LEVEL_LARGER'
    WINDOW_MANAGER_THEME='StoneageThick'
fi

#####################################################
#
#               Setting UI values
#
#####################################################

SYSTRAY_PROP_BASE=$(xfconf-query -c xfce4-panel -p '/plugins' -l -v \
    | grep systray | awk '{ print $1 }')

XFCONF_SETTINGS=(
    "thunar /last-icon-view-zoom-level string $THUNAR_ZOOM"
    "thunar /last-window-height int $THUNAR_WINDOW_HEIGHT"
    "thunar /last-window-width int $THUNAR_WINDOW_WIDTH"
    "thunar /shortcuts-icon-size string $THUNAR_ICON_SIZE"
    "thunar /tree-icon-size string $THUNAR_ICON_SIZE"
    "xfwm4 /general/margin_top int $PANEL_SIZE"
    "xfwm4 /general/theme string $WINDOW_MANAGER_THEME"
    "xfce4-panel /panels/panel-1/size int $PANEL_SIZE"
    "xfce4-panel $SYSTRAY_PROP_BASE/size-max int $SYSTRAY_ICON_SIZE"
    "xsettings /Gtk/CursorThemeSize int $CURSOR_SIZE"
    "xsettings /Gtk/IconSizes string $ICON_SIZES"
    "xsettings /Xfce/LastCustomDPI int $DPI"
    "xsettings /Xft/DPI int $DPI"
)

for XFCONF_DATA in "${XFCONF_SETTINGS[@]}"; do
    read -r CHANNEL PROP TYPE VALUE <<<"$XFCONF_DATA"

    xfconf-query -n -c "$CHANNEL" -p "$PROP" -t "$TYPE" -s "$VALUE"
done

sed -i -E "s/theme=.+/theme=$EYES_THEME/g" \
    "$HOME/.config/xfce4/panel/eyes-4.rc"
